#!/usr/bin/env python
"""mkauthmap -c url.conf -c CONFIGFILE -o FILE

Queries CRIC roles .json and put it into /data/srv/state/frontend/etc/
"""
import os 
import subprocess
import sys, urllib2,os.path
from optparse import OptionParser
from tempfile import mkstemp
from shutil import copyfile

#Global vars
datain = None
opts = None
args = None
roles = "" 
url = "http://cms-cric-dev-3.cern.ch/accounts/user/query/?json&preset=roles"


#Funtions
#TODO create a log file to registed when the fetch fails!!

# def getFecthDetails(file):

#   print "in file" 
#   print file
#   nline = 0
#   url = ""
#   for line in open(file,"r"):
#     nline += 1
#     url = re.match(r"^url (cric?:\S+) (\S+)$", line)

#   fd.close()
#   return url


def request(url):
  req = urllib2.Request(url)
  response = urllib2.urlopen(req)
  content = response.read()
  return content

def diffFiles(file1, file2):
  command = "diff " + file1 + " " + file2
  p = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
  stdout = p.communicate()[0]
  #for debuging
  debug_file = open('/home/h4d4/sitedb-cric/out-diff.txt', 'w')
  debug_file.write(stdout)

  return p.returncode

#return resp

#-------Main-------------
#Geting command line ooptions
opt = OptionParser()
opt.add_option("-o", "--out", dest="out", metavar="FILE", help="output file")
opt.add_option("-c", "--conf", dest="conf", metavar="FILE", help="configuration file")
opts, args = opt.parse_args()



#getFecthDetails(opts.conf)

roles = request(url)

#checking that query get something
if roles is None:
  print("null")
  sys.exit(0)
else:
  fd, tmpname= mkstemp(dir = os.path.dirname(opts.out))
  tmpfile = os.fdopen(fd, "w")
  tmpfile.write(roles)
  #print >> tmpfile, roles

  diff = diffFiles(tmpname,opts.out)
  #------------------------Debuggin differences------------------------
  command = "cp " + opts.out + " " + "/home/h4d4/sitedb-cric/roles-cric-old"
  p = subprocess.Popen(command, stdout=subprocess.PIPE, shell=True)
  stdout = p.communicate()[0]

  if (diff == 0) :
    print "files =="
    sys.exit(0)
  else:
#------------------------Debuggin differences------------------------
  #Next lines are for debuggin, to check diferences between the old tmpFile and opts.out(that has the content of the new tmpFile)
    #command = "cp " + tmpname + " " + opts.out
    print "files  differents"
    command2 = "cp " + tmpname + " " + "/home/h4d4/sitedb-cric/newtmp"
    p2 = subprocess.Popen(command2, stdout=subprocess.PIPE, shell=True)
    stdout2 = p2.communicate()[0]
#------------------------Debuggin differences------------------------
  #Updating roles-cric
    command3 = "cp " + tmpname + " " + opts.out
    p3 = subprocess.Popen(command3, stdout=subprocess.PIPE, shell=True)
    stdout3 = p3.communicate()[0]

#------------------------cloding and deleting file------------------------
  tmpfile.close()
  tmpfile.delete() ###FILE have not being deleted

  # command4 = "rm " + tmpname + " " + opts.out
  # p4 = subprocess.Popen(command4, stdout=subprocess.PIPE, shell=True)
  # stdout4 = p4.communicate()[0]
  #os.remove(tmpname)
  sys.exit(0)